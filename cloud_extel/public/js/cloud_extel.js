!function(){"use strict";["GL Entry","Sales Invoice","Purchase Invoice","Payment Entry","Asset","Expense Claim","Stock Entry","Budget","Payroll Entry","Delivery Note","Shipping Rule","Loyalty Program","Fee Schedule","Fee Structure","Stock Reconciliation","Travel Request","Fees","POS Profile","Opening Invoice Creation Tool","Subscription","Purchase Order","Journal Entry","Material Request","Purchase Receipt","Landed Cost Item","Asset"].forEach(function(t){frappe.ui.form.on(t,{cost_center:function(t){frappe.call({method:"frappe.client.get_list",args:{filters:{business_segment:t.doc.cost_center},doctype:"Business Segment",fields:["parent"],parent:"Telecom Region",limit_page_length:300},callback:function(e){t.set_query("telecom_region",function(){var t=e.message;return{filters:{name:["in",t=t.map(function(t){return t.parent})]}}})}})}})}),frappe.provide("frappe.views"),frappe.provide("erpnext.projects"),erpnext.projects.ProjectTree=class extends frappe.views.BaseList{constructor(t){super(t),this.show(),window.cur_list=this,this.hide_sort_selector=!0,this.view_name="List"}setup_defaults(){super.setup_defaults(),this.task_meta=frappe.get_meta("Task"),this.task_fields=[],this.task_columns=[],this.get_settings("Project","project_listview_settings"),this.get_settings("Task","task_listview_settings"),this.menu_items=[]}setup_page(){this.$page=$(this.parent),this.page&&this.page.page_form.removeClass("row").addClass("flex"),this.page&&this.page.body.addClass("frappe-card"),this.setup_page_head()}setup_page_head(){this.set_title("Projects"),this.set_menu_items("Project"),this.set_breadcrumbs()}set_menu_items(t){var e=this;frappe.model.can_delete(t)&&this.menu_items.push({label:__("Delete"),action:function(){var s=e.get_checked_items(!0).map(function(t){return t.toString()});frappe.confirm(__("Delete {0} items permanently?",[s.length]),function(){frappe.call({method:"frappe.desk.reportview.delete_items",freeze:!0,args:{items:s,doctype:t}}).then(function(t){var i=t.message;i||(i=[]),i.length&&!t._server_messages&&frappe.throw(__("Cannot delete {0}",[i.map(function(t){return t.bold()}).join(", ")])),i.length<s.length&&frappe.utils.play_sound("delete"),e.refresh()})})},standard:!0}),this.page&&this.menu_items.map(function(t){var s=e.page.add_menu_item(t.label,t.action,t.standard,t.shortcut);t.class&&s&&s.addClass(t.class)})}refresh_columns(){this.show()}set_title(t){this.page&&this.page.set_title(t)}setup_view(){this.columns=this.setup_columns("Project",this.meta,this.project_listview_settings),this.task_columns=this.setup_columns("Task",this.task_meta,this.task_listview_settings),this.render_header(this.columns),this.render_skeleton(),this.setup_events()}setup_fields(){super.setup_fields(),this.set_task_fields(),this.build_task_fields()}set_task_fields(){var t=this;[].concat(frappe.model.std_fields_list,this.get_fields_in_list_view("Task",this.task_meta),[this.meta.title_field,this.meta.image_field],this.settings.add_fields||[],this.meta.track_seen?"_seen":null,this.sort_by,"enabled","disabled","color").forEach(function(e){return t._add_task_field(e)}),this.task_fields.forEach(function(e){var s=frappe.meta.get_docfield(e[1],e[0]);s&&"Currency"===s.fieldtype&&s.options&&!s.options.includes(":")&&t._add_field(s.options)})}build_task_fields(){var t=this;this.task_fields=this.task_fields.map(function(e){return"string"==typeof e&&(e=[e,t.doctype]),e}),this.task_fields=this.task_fields.filter(Boolean),this.task_fields=this.task_fields.uniqBy(function(t){return t[0]+t[1]})}_add_task_field(t){if(t){var e="Task";if("object"==typeof t){var s=t;t=s.fieldname,e=s.parent}(frappe.model.std_fields_list.includes(t)||frappe.meta.has_field(e,t)||"_seen"===t)&&this.task_fields.push([t,e])}}get_df(t,e){return frappe.meta.get_docfield(t,e)}setup_columns(t,e,s){var i=[];e.title_field?i.push({type:"Subject",df:this.get_df(t,e.title_field)}):i.push({type:"Subject",df:{label:__("Name"),fieldname:"name"}}),frappe.has_indicator(t)&&i.push({type:"Status"});var a=this.get_fields_in_list_view(t,e);i=i.concat(a.filter(function(s){return(!frappe.has_indicator(t)||"status"!==s.fieldname)&&(!!s.in_list_view&&s.fieldname!==e.title_field)}).map(function(t){return{type:"Field",df:t}})),s&&s.fields&&(i=this.reorder_listview_fields(i,s.fields));var n=6;return window.innerWidth<=1366?n=4:window.innerWidth>=1920&&(n=8),s&&s.total_fields&&(n=parseInt(s.total_fields)),i.slice(0,n)}reorder_listview_fields(t,e){var s=[];for(var i in e=JSON.parse(e),s.push(t[0]),t.splice(0,1),e)for(var a in t){var n=e[i],r=t[a];if("Status"==r.type&&"status_field"==n.fieldname){s.push(r);break}if("Field"==r.type&&n.fieldname===r.df.fieldname){s.push(r);break}}return s}get_fields_in_list_view(t,e){return e.fields.filter(function(e){return frappe.model.is_value_type(e.fieldtype)&&e.in_list_view&&frappe.perm.has_perm(t,e.permlevel,"read")||"Currency"===e.fieldtype&&e.options&&!e.options.includes(":")||"status"===e.fieldname})}render_skeleton(){var t=this.get_list_row_html_skeleton('<div><input type="checkbox" /></div>');this.$result.append(t)}set_fields(){var t=this;[].concat(frappe.model.std_fields_list,this.get_fields_in_list_view("Project",this.meta),[this.meta.title_field,this.meta.image_field],this.settings.add_fields||[],this.meta.track_seen?"_seen":null,this.sort_by,"enabled","disabled","color").forEach(function(e){return t._add_field(e)}),this.fields.forEach(function(e){var s=frappe.meta.get_docfield(e[1],e[0]);s&&"Currency"===s.fieldtype&&s.options&&!s.options.includes(":")&&t._add_field(s.options)})}get_task_fields(){return this.task_fields.map(function(t){return frappe.model.get_full_column_name(t[0],t[1])})}get_call_args(t){return{method:"cloud_extel.cloud_extel.page.project_treeview.project_treeview.get_projects_data",args:{params:{doctype:"Project",fields:this.get_fields(),filters:t||this.get_filters_for_args(),with_comment_count:!0,page_length:this.page_length,start:this.start}}}}get_task_call_args(t){return{method:"cloud_extel.cloud_extel.page.project_treeview.project_treeview.get_tasks",args:{params:{doctype:"Task",fields:this.get_task_fields(),filters:t,with_comment_count:!0,page_length:this.page_length}}}}setup_side_bar(){}get_settings(t,e){var s=this;return frappe.call({method:"frappe.desk.listview.get_list_settings",args:{doctype:t},async:!1}).then(function(t){return s[e]=t.message||{}})}setup_events(){this.get_tasks(),this.setup_check_events(),this.setup_open_doc(),this.setup_task_tree_dropdown(),this.setup_create_new_task(),this.get_projects(),this.setup_expand_all_rows(),this.setup_collapse_all_rows()}setup_task_tree_dropdown(){var t=this;this.$result.on("click","svg.icon",function(e){var s=e.currentTarget,i=$(s);i.find("use.mb-1").attr("href","#icon-down");var a=unescape(s.getAttribute("data-name"));t.render_task(a,i)})}render_task(t,e,s){var i=this,a=this.$result.find('.list-rows[data-name="'+t+'"]');if(a&&a.length){e||(e=a.find("use.mb-1").attr("href","#icon-down"));var n=a.find(".nested-list-row-container"),r=$(n),l=parseInt(a[0].getAttribute("data-level"))+1,_=$('<div class="nested-result">');r.toggleClass("hide"),r[0].classList.contains("hide")&&(r.find(".nested-result").remove(),e.find("use.mb-1").attr("href","#icon-right")),frappe.call(this.get_task_call_args([["Task","parent_task","=",t]])).then(function(t){i.prepare_data(t),n.append(_),i.data.map(function(t,e){t._idx=e,t.doctype="Task",_.append(i.get_task_list_row_html(t,l))}),s&&i.$result.find(".expand-all").click()})}}setup_open_doc(){this.$result.on("click",".btn-open",function(t){t.stopPropagation();var e=t.currentTarget,s=unescape(e.getAttribute("data-doctype")),i=unescape(e.getAttribute("data-name"));frappe.set_route("Form",s,i)})}setup_create_new_task(){this.$result.on("click",".create-new",function(t){var e=unescape(t.currentTarget.getAttribute("data-name")),s=unescape(t.currentTarget.getAttribute("data-project")),i=frappe.model.get_new_doc("Task");i.project=s,i.parent_task=e,frappe.ui.form.make_quick_entry("Task",null,null,i)})}get_projects(){var t=this;this.$frappe_list.on("click",".btn-prev",function(){t.filter_area.clear(!1),t.set_title("Project"),t.remove_previous_button(),t.render_header(t.columns,!0),t.filter_area.refresh_filters(t.meta),t.fetch_projects()})}fetch_projects(){var t=this;frappe.call(this.get_call_args([])).then(function(e){t.render_header(t.columns,!0),t.prepare_data(e),t.toggle_result_area(),t.render()})}get_tasks(){var t=this;this.$result.on("click",".project-list-row-container",function(e){t.filter_area.clear(!1),t.set_title("Task Tree"),t.filter_area.refresh_filters(t.task_meta),t.fetch_tasks(unescape(e.currentTarget.getAttribute("data-name")))})}fetch_tasks(t){var e=this;t&&this.filter_area.add([["Task","project","=",t]],!1);var s=this.get_filters_for_args();s.push(["Task","parent_task","=",""]),frappe.call(this.get_task_call_args(s)).then(function(s){e.render_header(e.task_columns,!0),e.prepare_data(s),e.render("Task",!0,t),e.render_previous_button()})}setup_expand_all_rows(){var t=this;this.$result.on("click",".expand-all",function(){var e=t.$result.find("use[href='#icon-right']").parent();t.toggle_expand_collapse_button("expand"),e&&e.map(function(e,s){var i=s.getAttribute("data-name");i&&t.render_task(i,null,!0)})})}setup_collapse_all_rows(){var t=this;this.$result.on("click",".collapse-all",function(){var e=t.$result.find("use[href='#icon-down']").parent();t.toggle_expand_collapse_button("collapse"),e&&e.map(function(e,s){var i=s.getAttribute("data-name"),a=t.$result.find('.list-rows[data-name="'+i+'"]'),n=a.find(".nested-list-row-container"),r=$(n);r.toggleClass("hide"),r.length&&r[0].classList.contains("hide")&&(r.find(".nested-result").remove(),a.find("use.mb-1").attr("href","#icon-right"))})})}toggle_expand_collapse_button(t){var e="expand"==t?".expand-all":".collapse-all",s="expand"==t?".collapse-all":".expand-all";this.$result.find(e).hide(),this.$result.find(s).show()}render(t,e,s){var i=this;void 0===e&&(e=!1),void 0===s&&(s=null),this.$result.find(".list-row-container").remove(),this.data.length>0&&this.$result.append(this.data.map(function(a,n){return a._idx=n,a.doctype=t||i.doctype,e&&s&&(a.project=s),e?i.get_task_list_row_html(a,0):i.get_list_row_html(a)}).join(""))}setup_no_result_area(){this.$no_result=$('\n\t\t\t<div class="no-result text-muted flex justify-center align-center">\n\t\t\t\t'+this.get_no_result_message()+"\n\t\t\t</div>\n\t\t").hide(),this.$no_result_prev=$(this.get_previous_header_html()).hide(),this.$frappe_list.append(this.$no_result_prev),this.$frappe_list.append(this.$no_result)}toggle_result_area(){this.$result.toggle(this.data.length>0),this.$paging_area.toggle(this.data.length>0),this.$no_result.toggle(0==this.data.length),this.$no_result_prev.toggle(0==this.data.length);var t=this.start+this.page_length<=this.data.length;this.$paging_area.find(".btn-more").toggle(t)}setup_filter_area(){if(this.filter_area=new erpnext.projects.CustomFilterArea(this),this.filters&&this.filters.length>0)return this.filter_area.set(this.filters)}get_list_row_html(t){return this.get_list_row_html_skeleton(this.get_left_html(this.columns,t),this.get_right_html(t),t)}get_task_list_row_html(t,e){return this.get_task_list_row_html_skeleton(this.get_left_html(this.task_columns,t,e),this.get_right_html(t,!0),t,e)}get_list_row_html_skeleton(t,e,s){return void 0===t&&(t=""),void 0===e&&(e=""),void 0===s&&(s={}),'\n\t\t\t<div class="list-row-container project-list-row-container" tabindex="1" data-doctype="Project" data-name="'+escape(s.name)+'">\n\t\t\t\t<div class="level list-row small">\n\t\t\t\t\t<div class="level-left ellipsis">\n\t\t\t\t\t\t'+t+'\n\t\t\t\t\t</div>\n\t\t\t\t\t<div class="level-right text-muted ellipsis">\n\t\t\t\t\t\t'+e+"\n\t\t\t\t\t</div>\n\t\t\t\t</div>\n\t\t\t</div>\n\t\t"}get_task_list_row_html_skeleton(t,e,s,i){return void 0===t&&(t=""),void 0===e&&(e=""),void 0===s&&(s={}),'\n\t\t<div class="list-rows" data-doctype="Task" data-name="'+escape(s.name)+'" data-level="'+i+'">\n\t\t\t<div class="list-row-container" tabindex="1">\n\t\t\t\t<div class="level list-row small">\n\t\t\t\t\t<div class="level-left ellipsis">\n\t\t\t\t\t\t'+t+'\n\t\t\t\t\t</div>\n\t\t\t\t\t<div class="level-right text-muted ellipsis">\n\t\t\t\t\t\t'+e+'\n\t\t\t\t\t</div>\n\t\t\t\t</div>\n\t\t\t</div>\n\t\t\t<div class="nested-list-row-container hide">\n\t\t\t</div>\n\t\t</div>\n\t\t'}get_left_html(t,e,s){var i=this;return t.map(function(a){return i.get_column_html(a,t,e,s)}).join("")}get_right_html(t,e){return void 0===e&&(e=!1),this.get_meta_html(t,e)}get_column_html(t,e,s,i){var a=this;if("Status"===t.type)return'\n\t\t\t\t<div class="list-row-col hidden-xs ellipsis">\n\t\t\t\t\t'+this.get_indicator_html(s)+"\n\t\t\t\t</div>\n\t\t\t";var n=t.df||{},r=n.label,l=n.fieldname,_=s[l]||"";return'\n\t\t\t<div class="'+["list-row-col ellipsis",{Subject:"list-subject level",Field:"hidden-xs"}[t.type],frappe.model.is_numeric_field(n)?"text-right":""].join(" ")+'">\n\t\t\t\t'+{Subject:this.get_subject_html(e,s,i),Field:function(){var t,e;e=a.settings.formatters&&a.settings.formatters[l]?a.settings.formatters[l](_,n,s):"Text Editor"==n.fieldtype||n.fetch_from&&["Text","Small Text"].includes(n.fieldtype)?strip_html(_):"string"==typeof _?frappe.utils.escape_html(_):_;return t="Image"===n.fieldtype?n.options?'<img src="'+s[n.options]+'" style="max-level: 30px; max-width: 100%;">':'<div class="missing-image small">\n\t\t\t\t\t\t<span class="octicon octicon-circle-slash"></span>\n\t\t\t\t\t</div>':"Select"===n.fieldtype?'<span class="filterable indicator '+frappe.utils.guess_colour(e)+' ellipsis"\n\t\t\t\t\tdata-filter="'+l+",=,"+_+'">\n\t\t\t\t\t'+__(e)+"\n\t\t\t\t</span>":"Link"===n.fieldtype?'<a class="filterable text-muted ellipsis"\n\t\t\t\t\tdata-filter="'+l+",=,"+_+'">\n\t\t\t\t\t'+e+"\n\t\t\t\t</a>":["Text Editor","Text","Small Text","HTML Editor"].includes(n.fieldtype)?'<span class="text-muted ellipsis">\n\t\t\t\t\t'+e+"\n\t\t\t\t</span>":'<a class="filterable text-muted ellipsis"\n\t\t\t\t\tdata-filter="'+l+",=,"+_+'">\n\t\t\t\t\t'+("Code"===n.fieldtype?_:"Percent"===n.fieldtype?'<div class="progress level" style="margin: 0px;">\n\t\t\t\t\t\t<div class="progress-bar progress-bar-success" role="progressbar"\n\t\t\t\t\t\t\taria-valuenow="'+_+'"\n\t\t\t\t\t\t\taria-valuemin="0" aria-valuemax="100" style="width: '+Math.round(_)+'%;">\n\t\t\t\t\t\t</div>\n\t\t\t\t\t</div>':frappe.format(_,n,null,s))+"\n\t\t\t\t</a>",'<span class="ellipsis"\n\t\t\t\ttitle="'+__(r)+": "+escape(e)+'">\n\t\t\t\t'+t+"\n\t\t\t</span>"}()}[t.type]+"\n\t\t\t</div>\n\t\t"}get_subject_html(t,e,s){var i=frappe.session.user,a=e[t[0].df.fieldname]||e.name,n=strip_html(a.toString()),r=frappe.utils.escape_html(n),l=JSON.parse(e._seen||"[]").includes(i)?"":"bold",_=this.get_subject_link(e,n,r),o="Task"==e.doctype&&e.expandable?'<svg class="icon icon-sm" style=""\n\t\t\tdata-doctype="Task" data-name="'+escape(e.name)+'">\n\t\t\t\t<use class="mb-1" href="#icon-right"></use>\n\t\t\t</svg>':"";return'\n\t\t\t<span class="level-item select-like">\n\t\t\t\t<input class="list-row-checkbox" type="checkbox" data-name="'+escape(e.name)+'">\n\t\t\t\t<span class="list-row-like hidden-xs style="margin-bottom: 1px;">\n\t\t\t\t\t'+this.get_like_html(e)+'\n\t\t\t\t</span>\n\t\t\t</span>\n\t\t\t<span class="level-item '+l+' ellipsis" title="'+r+'" style="padding-left: '+20*s+'px;">\n\t\t\t\t<span class="level-item" style="margin-bottom: 1px;"">\n\t\t\t\t\t'+o+"\n\t\t\t\t</span>\n\t\t\t\t"+_+"\n\t\t\t</span>\n\t\t"}get_like_html(t){var e=JSON.parse(t._liked_by||"[]");return'<span\n\t\t\tclass="like-action '+(e.includes(frappe.session.user)?"liked-by liked":"not-liked")+'"\n\t\t\tdata-name="'+t.name+'" data-doctype="'+this.doctype+'"\n\t\t\tdata-liked-by="'+(encodeURI(t._liked_by)||"[]")+'"\n\t\t\ttitle="'+e.map(function(t){return frappe.user_info(t).fullname}).join(", ")+'">\n\t\t\t'+frappe.utils.icon("heart","sm","like-icon")+'\n\t\t</span>\n\t\t<span class="likes-count">\n\t\t\t'+(e.length>99?__("99")+"+":__(e.length||""))+"\n\t\t</span>"}get_subject_link(t,e,s){return"Project"===t.doctype?'<span class="ellipsis" title="'+s+'" data-doctype="'+t.doctype+'" data-name="'+t.name+'">\n\t\t\t\t'+e+"\n\t\t\t</span>":'<a href ="/app/task/'+t.name+'" class="ellipsis" title="'+s+'" data-doctype="'+t.doctype+'" data-name="'+t.name+'">\n\t\t\t\t'+e+"\n\t\t\t</a>"}get_indicator_html(t){var e=frappe.get_indicator(t,this.doctype);return e?'<span class="indicator '+e[1]+" filterable\"\n\t\t\t\tdata-filter='"+e[2]+"'>\n\t\t\t\t"+__(e[0])+"\n\t\t\t<span>":""}get_indicator_dot(t){var e=frappe.get_indicator(t,this.doctype);return e?"<span class='indicator "+e[1]+"' title='"+__(e[0])+"'></span>":""}get_avatar(t){return'<span class="filterable"\n\t\t\t\tdata-filter="_assign,like,%'+t+'%">\n\t\t\t\t'+frappe.avatar(t)+"\n\t\t\t</span>"}get_meta_html(t,e){var s="";e&&t.is_group&&(s+=this.get_add_child_button(t)),"Project"==t.doctype&&(s+=this.get_open_button(t));var i=this.comment_when(t.modified,!0),a=JSON.parse(t._assign||"[]").slice(-1)[0];return s+='\n\t\t\t<div class="level-item hidden-xs list-row-activity">\n\t\t\t\t'+i+"\n\t\t\t\t"+(a?this.get_avatar(a):'<span class="avatar avatar-small avatar-empty"></span>')+"\n\t\t\t\t"+('<span class="'+(t._comment_count?"":"text-extra-muted")+' comment-count">\n\t\t\t\t<i class="octicon octicon-comment-discussion"></i>\n\t\t\t\t'+(t._comment_count>99?"99+":t._comment_count)+"\n\t\t\t</span>")+'\n\t\t\t</div>\n\t\t\t<div class="level-item visible-xs text-right">\n\t\t\t\t'+this.get_indicator_dot(t)+"\n\t\t\t</div>\n\t\t"}get_open_button(t){return'\n\t\t\t\t<div class="level-item hidden-xs mr-3">\n\t\t\t\t\t<button class="btn btn-open btn-default btn-xs"\n\t\t\t\t\t\tdata-doctype="'+escape(t.doctype)+'" data-name="'+escape(t.name)+'">\n\t\t\t\t\t\t'+__("Open")+"\n\t\t\t\t\t</button>\n\t\t\t\t</div>\n\t\t\t"}get_add_child_button(t){return'\n\t\t\t\t<div class="level-item hidden-xs mr-3">\n\t\t\t\t\t<button class="btn create-new btn-default btn-xs"\n\t\t\t\t\t\tdata-name="'+escape(t.name)+'" data-project="'+escape(t.project)+'">\n\t\t\t\t\t\t'+__("Add Child")+"\n\t\t\t\t\t</button>\n\t\t\t\t</div>\n\t\t\t"}render_header(t,e){e&&this.$result.find(".list-row-head").remove(),0===this.$result.find(".list-row-head").length&&this.$result.prepend(this.get_header_html(t))}render_previous_button(){0===this.$result.find(".list-row-previous-head").length&&this.$result.prepend(this.get_previous_header_html())}remove_previous_button(){this.$result.find(".list-row-previous-head").remove()}get_header_html(t){var e=t[0].df,s='\n\t\t\t<input class="level-item list-check-all hidden-xs" type="checkbox" title="'+__("Select All")+'">\n\t\t\t<span class="level-item list-liked-by-me">\n\t\t\t\t<i class="octicon octicon-heart text-extra-muted" title="'+__("Likes")+'"></i>\n\t\t\t</span>\n\t\t\t<span class="level-item">'+__(e.label)+"</span>\n\t\t",i=t.map(function(t){return'\n\t\t\t\t<div class="'+["list-row-col ellipsis","Subject"==t.type?"list-subject level":"hidden-xs",frappe.model.is_numeric_field(t.df)?"text-right":""].join(" ")+'">\n\t\t\t\t\t'+("Subject"===t.type?s:"\n\t\t\t\t\t<span>"+__(t.df&&t.df.label||t.type)+"</span>")+"\n\t\t\t\t</div>\n\t\t\t"}).join("");return this.get_header_html_skeleton(i,'<span class="list-count"></span>')}get_previous_header_html(){return'\n\t\t\t<header class="level list-row list-row-head text-muted small">\n\t\t\t\t<a class="btn btn-prev btn-xs" style="margin-left: 15px;">\n\t\t\t\t\t<svg class="icon  icon-sm" style="">\n\t\t\t\t\t\t<use class="mb-1" href="#icon-left"></use>\n\t\t\t\t\t</svg>\n\t\t\t\t\t<span style="margin-left: 5px">Projects</span>\n\t\t\t\t</a>\n\t\t\t\t<button class="btn btn-xs expand-all btn-default" style="float: right">\n\t\t\t\t\t'+__("Expand All")+'</button>\n\t\t\t\t<button class="btn btn-xs collapse-all btn-default" style="float: right; display: none">\n\t\t\t\t\t'+__("Collapse All")+"</button>\n\t\t\t</header>\n\t\t"}on_row_checked(){this.$list_head_subject=this.$list_head_subject||this.$result.find("header .list-header-subject"),this.$checkbox_actions=this.$checkbox_actions||this.$result.find("header .checkbox-actions"),this.$checks=this.$result.find(".list-row-checkbox:checked"),this.$list_head_subject.toggle(0===this.$checks.length),this.$checkbox_actions.toggle(this.$checks.length>0),0===this.$checks.length?this.$list_head_subject.find(".list-check-all").prop("checked",!1):(this.$checkbox_actions.find(".list-header-meta").html(__("{0} items selected",[this.$checks.length])),this.$checkbox_actions.show(),this.$list_head_subject.hide())}get_checked_items(t){var e=Array.from(this.$checks||[]).map(function(t){return cstr(unescape($(t).data().name))});return t?e:this.data.filter(function(t){return e.includes(t.name)})}get_header_html_skeleton(t,e){return void 0===t&&(t=""),void 0===e&&(e=""),'\n\t\t\t<header class="level list-row list-row-head text-muted small">\n\t\t\t\t<div class="level-left list-header-subject">\n\t\t\t\t\t'+t+'\n\t\t\t\t</div>\n\t\t\t\t<div class="level-left checkbox-actions">\n\t\t\t\t\t<div class="level list-subject">\n\t\t\t\t\t\t<input class="level-item list-check-all hidden-xs" type="checkbox" title="'+__("Select All")+'">\n\t\t\t\t\t\t<span class="level-item list-header-meta"></span>\n\t\t\t\t\t</div>\n\t\t\t\t</div>\n\t\t\t\t<div class="level-right">\n\t\t\t\t\t'+e+"\n\t\t\t\t</div>\n\t\t\t</header>\n\t\t"}setup_check_events(){var t=this;this.$result.on("change","input[type=checkbox]",function(e){var s=$(e.currentTarget);if(e.stopPropagation(),s.is(".list-header-subject .list-check-all")){var i=t.$result.find(".checkbox-actions .list-check-all");i.prop("checked",s.prop("checked")),i.trigger("change")}else if(s.is(".checkbox-actions .list-check-all")){t.$result.find(".list-header-subject .list-check-all").prop("checked",s.prop("checked")),t.$result.find(".list-row-checkbox").prop("checked",s.prop("checked"))}t.on_row_checked()}),this.$result.on("click",".list-row-checkbox",function(e){var s,i=$(e.currentTarget);if(e.stopPropagation(),e.shiftKey&&t.$checkbox_cursor&&!i.is(t.$checkbox_cursor)){var a=t.$checkbox_cursor.data().name,n=i.data().name,r=[t.data.findIndex(function(t){return t.name===a}),t.data.findIndex(function(t){return t.name===n})],l=r[0],_=r[1];l>_&&(l=(s=[_,l])[0],_=s[1]);var o=t.data.slice(l+1,_).map(function(t){return t.name}).map(function(t){return'.list-row-checkbox[data-name="'+t+'"]'}).join(",");t.$result.find(o).prop("checked",!0)}t.$checkbox_cursor=i})}comment_when(t,e){return'<span class="frappe-timestamp '+(e?" mini":"")+'" data-timestamp="'+t+'" title="'+(frappe.datetime.str_to_user?frappe.datetime.str_to_user(t):t)+'">'+this.prettyDate(t,e)+"</span>"}convert_to_user_tz(t){return t=frappe.datetime.convert_to_user_tz(t),new Date((t||"").replace(/-/g,"/").replace(/[TZ]/g," ").replace(/\.[0-9]*/,""))}prettyDate(t,e){if(!t)return"";"string"==typeof t&&(t=this.convert_to_user_tz(t));var s=((new Date).getTime()-t.getTime())/1e3,i=Math.floor(s/86400);if(isNaN(i)||i<0)return"";if(e){if(0!=i)return i<7?__("{0} d",[i]):i<31?__("{0} w",[Math.ceil(i/7)]):i<365?__("{0} M",[Math.ceil(i/30)]):__("{0} y",[Math.ceil(i/365)]);if(s<60)return __("now");if(s<3600)return __("{0} m",[Math.floor(s/60)]);if(s<86400)return __("{0} h",[Math.floor(s/3600)])}else{if(0!=i)return 1==i?__("yesterday"):i<7?__("{0} days ago",[i]):i<14?__("1 week ago"):i<31?__("{0} weeks ago",[Math.ceil(i/7)]):i<62?__("1 month ago"):i<365?__("{0} months ago",[Math.ceil(i/30)]):i<730?__("1 year ago"):__("{0} years ago",[Math.ceil(i/365)]);if(s<60)return __("just now");if(s<120)return __("1 minute ago");if(s<3600)return __("{0} minutes ago",[Math.floor(s/60)]);if(s<7200)return __("1 hour ago");if(s<86400)return __("{0} hours ago",[Math.floor(s/3600)])}}},erpnext.projects.CustomFilterArea=class{constructor(t){this.list_view=t,this.list_view.page.page_form.append('<div class="standard-filter-section flex"></div>');var e=this.list_view.hide_page_form?this.list_view.page.custom_actions:this.list_view.page.page_form;this.list_view.$filter_section=$('<div class="filter-section flex">').appendTo(e),this.$filter_list_wrapper=this.list_view.$filter_section,this.trigger_refresh=!0,this.setup()}setup(){this.list_view.hide_page_form||this.make_standard_filters(),this.make_filter_list()}get(){var t=this.filter_list.get_filters(),e=this.get_standard_filters();return t.concat(e).uniqBy(JSON.stringify)}set(t){var e=this;return this.trigger_refresh=!1,this.add(t,!1).then(function(){e.trigger_refresh=!0,e.filter_list.update_filter_button()})}add(t,e){var s=this;if(void 0===e&&(e=!0),!t||Array.isArray(t)&&0===t.length)return Promise.resolve();"string"==typeof t[0]&&(t=[Array.from(arguments)]);t=t.filter(function(t){return!s.exists(t)});var i=this.set_standard_filter(t),a=i.non_standard_filters;return i.promise.then(function(){return a.length>0&&s.filter_list.add_filters(a)}).then(function(){e&&s.list_view.refresh()})}refresh_list_view_old(){this.trigger_refresh&&(this.list_view.start=0,this.list_view.refresh(),this.list_view.on_filter_change())}exists(t){var e=!1,s=this.list_view.page.fields_dict;"="===t[2]&&t[1]in s&&(s[t[1]].get_value()&&(e=!0));return e||(e=this.filter_list.filter_exists(t)),e}set_standard_filter(t){if(0===t.length)return{non_standard_filters:[],promise:Promise.resolve()};var e=this.list_view.page.fields_dict;return t.reduce(function(t,s){s[0];var i=s[1],a=s[2],n=s[3];return t.promise=t.promise||Promise.resolve(),t.non_standard_filters=t.non_standard_filters||[],!e[i]||"="!==a&&"like"!==a?t.non_standard_filters.push(s):t.promise=t.promise.then(function(){return e[i].set_value(n)}),t},{})}remove_filters(t){var e=this;t.map(function(t){e.remove(t[1])})}remove(t){var e=this.list_view.page.fields_dict;t in e&&e[t].set_value("");var s=this.filter_list.get_filter(t);return s&&s.remove(),this.filter_list.apply(),Promise.resolve()}clear(t){var e=this;void 0===t&&(t=!0),t||(this.trigger_refresh=!1),this.filter_list.clear_filters();var s=[],i=this.list_view.page.fields_dict,a=function(t){var i=e.list_view.page.fields_dict[t];s.push(function(){return i.set_value("")})};for(var n in i)a(n);return frappe.run_serially(s).then(function(){e.trigger_refresh=!0})}make_standard_filters_old(){var t=this;this.standard_filters_wrapper=this.list_view.page.page_form.find(".standard-filter-section");var e=[{fieldtype:"Data",label:"Name",condition:"like",fieldname:"name",onchange:function(){return t.refresh_list_view()}}];this.list_view.custom_filter_configs&&(this.list_view.custom_filter_configs.forEach(function(e){e.onchange=function(){return t.refresh_list_view()}}),e=e.concat(this.list_view.custom_filter_configs));var s=this.list_view.meta.fields,i=this.list_view.meta.title_field;(e=e.concat(s.filter(function(t){return t.fieldname===i||t.in_standard_filter&&frappe.model.is_value_type(t.fieldtype)}).map(function(e){var s=e.options,i="=",a=e.fieldtype;["Text","Small Text","Text Editor","HTML Editor","Data","Code","Read Only"].includes(a)&&(a="Data",i="like"),"Select"==e.fieldtype&&e.options&&(s=e.options.split("\n")).length>0&&""!=s[0]&&(s.unshift(""),s=s.join("\n"));var n="Link"===a?frappe.defaults.get_user_default(s):null;return["__default","__global"].includes(n)&&(n=null),{fieldtype:a,label:__(e.label),options:s,fieldname:e.fieldname,condition:i,default:n,onchange:function(){return t.refresh_list_view()},ignore_link_validation:"Dynamic Link"===a,is_filter:1}}))).map(function(e){t.list_view.page.add_field(e,t.standard_filters_wrapper)})}get_standard_filters(){var t=[],e=this.list_view.page.fields_dict;for(var s in e){var i=e[s],a=i.get_value();a&&("like"!==i.df.condition||a.includes("%")||(a="%"+a+"%"),t.push([this.list_view.doctype,i.df.fieldname,i.df.condition||"=",a]))}return t}make_filter_list_old(){var t=this;$('<div class="filter-selector">\n\t\t\t<button class="btn btn-default btn-sm filter-button">\n\t\t\t\t<span class="filter-icon">\n\t\t\t\t\t'+frappe.utils.icon("filter")+'\n\t\t\t\t</span>\n\t\t\t\t<span class="button-label hidden-xs">\n\t\t\t\t\t'+__("Filter")+"\n\t\t\t\t<span>\n\t\t\t</button>\n\t\t</div>").appendTo(this.$filter_list_wrapper),this.filter_button=this.$filter_list_wrapper.find(".filter-button"),this.filter_list=new frappe.ui.FilterGroup({base_list:this.list_view,parent:this.$filter_list_wrapper,doctype:this.list_view.doctype,filter_button:this.filter_button,default_filters:[],on_change:function(){return t.refresh_list_view()}})}is_being_edited(){return this.filter_list&&this.filter_list.wrapper&&this.filter_list.wrapper.find(".filter-box:visible").length>0}refresh_filters(t){this.list_view.page.clear_fields(),this.list_view.current_doctype=t.name;var e=$(this.list_view.parent).find(".filter-section");e&&e.remove(),this.list_view.doctype=t.name,this.make_standard_filters(t);var s=this.list_view.hide_page_form?this.list_view.page.custom_actions:this.list_view.page.page_form;this.$filter_list_wrapper=$('<div class="filter-section flex">').appendTo(s),this.make_filter_list(t.name),this.clear(!1)}make_standard_filters(t){var e=this;t||(t=this.list_view.meta);var s=[{fieldtype:"Data",label:"Name",condition:"like",fieldname:"name",onchange:function(){return e.refresh_list_view()}}],i=t.fields,a=t.title_field;s=s.concat(i.filter(function(t){return t.fieldname===a||t.in_standard_filter&&frappe.model.is_value_type(t.fieldtype)}).map(function(t){var s=t.options,i="=",a=t.fieldtype;["Text","Small Text","Text Editor","HTML Editor","Data","Code","Read Only"].includes(a)&&(a="Data",i="like"),"Select"==t.fieldtype&&t.options&&(s=t.options.split("\n")).length>0&&""!=s[0]&&(s.unshift(""),s=s.join("\n"));var n="Link"===a?frappe.defaults.get_user_default(s):null;return["__default","__global"].includes(n)&&(n=null),{fieldtype:a,label:__(t.label),options:s,fieldname:t.fieldname,condition:i,default:n,onchange:function(){return e.refresh_list_view()},ignore_link_validation:"Dynamic Link"===a,is_filter:1}})),this.standard_filters_wrapper=this.list_view.page.page_form.find(".standard-filter-section"),0==this.standard_filters_wrapper.length&&(this.list_view.page.page_form.append('<div class="standard-filter-section flex"></div>'),this.standard_filters_wrapper=this.list_view.page.page_form.find(".standard-filter-section")),s.map(function(t){e.list_view.page.add_field(t,e.standard_filters_wrapper)})}make_filter_list(t){var e=this;t||(t=this.list_view.doctype),$('<div class="filter-selector">\n\t\t\t<button class="btn btn-default btn-sm filter-button">\n\t\t\t\t<span class="filter-icon">\n\t\t\t\t\t'+frappe.utils.icon("filter")+'\n\t\t\t\t</span>\n\t\t\t\t<span class="button-label hidden-xs">\n\t\t\t\t\t'+__("Filter")+"\n\t\t\t\t<span>\n\t\t\t</button>\n\t\t</div>").appendTo(this.$filter_list_wrapper),this.filter_button=this.$filter_list_wrapper.find(".filter-button"),this.filter_list=new frappe.ui.FilterGroup({base_list:this.list_view,parent:this.$filter_list_wrapper,doctype:t,default_filters:[],filter_button:this.filter_button,on_change:function(){return e.refresh_list_view()}})}refresh_list_view(){if(this.trigger_refresh){if("Task"==this.list_view.doctype)return void this.list_view.fetch_tasks();this.list_view.start=0,this.list_view.refresh(),this.list_view.on_filter_change()}}}}();
//# sourceMappingURL=cloud_extel.js.map
